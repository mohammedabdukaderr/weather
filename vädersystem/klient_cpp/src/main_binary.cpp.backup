#include "vaderprotokoll.h"
#include "natverks_abstraktion.h"
#include <iostream>
#include <string>
#include <cstring>
#include <iomanip>

using namespace std;

// VaderKlient - Objektorienterad klient f√∂r v√§dersystemet
class VaderKlient {
private:
    string server_adress;              // Serveradress (IP eller v√§rdnamn)
    int server_port;                   // Serverport
    socket_t socket_anslutning;        // Socket f√∂r anslutning

public:
    // Konstruktor
    VaderKlient(const string& adress, int port)
        : server_adress(adress), server_port(port), socket_anslutning(OGILTIG_SOCKET) {
        // Initialisera n√§tverksbibliotek
        if (initiera_natverksbibliotek() != 0) {
            throw runtime_error("Kunde inte initialisera n√§tverksbibliotek");
        }
    }

    // Destruktor
    ~VaderKlient() {
        kopplaFran();
        rensa_natverksbibliotek();
    }

    // Anslut till server
    bool anslutt() {
        socket_anslutning = socket(AF_INET, SOCK_STREAM, 0);
        if (socket_anslutning == OGILTIG_SOCKET) {
            cerr << "FEL: Kunde inte skapa socket" << endl;
            return false;
        }

        struct sockaddr_in server_addr;
        memset(&server_addr, 0, sizeof(server_addr));
        server_addr.sin_family = AF_INET;
        server_addr.sin_port = htons(static_cast<uint16_t>(server_port));

#ifdef _WIN32
        server_addr.sin_addr.s_addr = inet_addr(server_adress.c_str());
#else
        inet_pton(AF_INET, server_adress.c_str(), &server_addr.sin_addr);
#endif

        cout << "Ansluter till " << server_adress << ":" << server_port << "..." << endl;

        if (connect(socket_anslutning, (struct sockaddr*)&server_addr,
                   sizeof(server_addr)) < 0) {
            cerr << "FEL: Kunde inte ansluta till server" << endl;
            stang_socket(socket_anslutning);
            socket_anslutning = OGILTIG_SOCKET;
            return false;
        }

        cout << "‚úì Ansluten till server!" << endl;
        return true;
    }

    // Koppla fr√•n server
    void kopplaFran() {
        if (socket_anslutning != OGILTIG_SOCKET) {
            stang_socket(socket_anslutning);
            socket_anslutning = OGILTIG_SOCKET;
        }
    }

    // H√§mta aktuellt v√§der
    bool hamtaAktuellVader(const string& stad, const string& landskod) {
        if (socket_anslutning == OGILTIG_SOCKET) {
            cerr << "FEL: Inte ansluten till server" << endl;
            return false;
        }

        // Skapa protokollhuvud
        ProtokollHuvud huvud;
        huvud.version = PROTOKOLL_VERSION;
        huvud.typ = MEDDELANDE_HAMTA_VADER;
        huvud.langd = hton16(sizeof(VaderForfragan));

        // Skapa f√∂rfr√•gan
        VaderForfragan forfragan;
        memset(&forfragan, 0, sizeof(forfragan));
        strncpy(forfragan.stad, stad.c_str(), sizeof(forfragan.stad) - 1);
        strncpy(forfragan.landskod, landskod.c_str(), sizeof(forfragan.landskod) - 1);

        // Skicka f√∂rfr√•gan
        if (send(socket_anslutning, (char*)&huvud, sizeof(huvud), 0) != sizeof(huvud) ||
            send(socket_anslutning, (char*)&forfragan, sizeof(forfragan), 0) != sizeof(forfragan)) {
            cerr << "FEL: Kunde inte skicka f√∂rfr√•gan" << endl;
            return false;
        }

        // Ta emot svar
        ProtokollHuvud svar_huvud;
        if (recv(socket_anslutning, (char*)&svar_huvud, sizeof(svar_huvud), 0) != sizeof(svar_huvud)) {
            cerr << "FEL: Kunde inte ta emot svar" << endl;
            return false;
        }

        // Hantera fel
        if (svar_huvud.typ == MEDDELANDE_FEL) {
            FelMeddelande fel;
            recv(socket_anslutning, (char*)&fel, sizeof(fel), 0);
            cerr << "FEL fr√•n server: " << fel.meddelande << " (kod: " << fel.felkod << ")" << endl;
            return false;
        }

        // Ta emot v√§derdata
        VaderData vader_data;
        if (recv(socket_anslutning, (char*)&vader_data, sizeof(vader_data), 0) != sizeof(vader_data)) {
            cerr << "FEL: Kunde inte ta emot v√§derdata" << endl;
            return false;
        }

        // Visa v√§derdata
        visaVaderData(vader_data);
        return true;
    }

    // H√§mta prognos
    bool hamtaPrognos(const string& stad, const string& landskod) {
        if (socket_anslutning == OGILTIG_SOCKET) {
            return false;
        }

        // Skapa protokollhuvud
        ProtokollHuvud huvud;
        huvud.version = PROTOKOLL_VERSION;
        huvud.typ = MEDDELANDE_HAMTA_PROGNOS;
        huvud.langd = hton16(sizeof(VaderForfragan));

        // Skapa f√∂rfr√•gan
        VaderForfragan forfragan;
        memset(&forfragan, 0, sizeof(forfragan));
        strncpy(forfragan.stad, stad.c_str(), sizeof(forfragan.stad) - 1);
        strncpy(forfragan.landskod, landskod.c_str(), sizeof(forfragan.landskod) - 1);

        // Skicka
        send(socket_anslutning, (char*)&huvud, sizeof(huvud), 0);
        send(socket_anslutning, (char*)&forfragan, sizeof(forfragan), 0);

        // Ta emot svar
        ProtokollHuvud svar_huvud;
        recv(socket_anslutning, (char*)&svar_huvud, sizeof(svar_huvud), 0);

        if (svar_huvud.typ == MEDDELANDE_FEL) {
            FelMeddelande fel;
            recv(socket_anslutning, (char*)&fel, sizeof(fel), 0);
            cerr << "FEL: " << fel.meddelande << endl;
            return false;
        }

        // Ta emot prognos
        VaderPrognos prognos;
        recv(socket_anslutning, (char*)&prognos, sizeof(prognos), 0);

        // Visa prognos
        visaPrognos(prognos);
        return true;
    }

private:
    // Visa v√§derdata i terminalen
    void visaVaderData(const VaderData& data) {
        cout << "\n";
        cout << "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" << endl;
        cout << "‚ïë        AKTUELLT V√ÑDER - " << setw(26) << left << data.stad << "‚ïë" << endl;
        cout << "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" << endl;
        cout << "‚ïë  üå°Ô∏è  Temperatur:    " << setw(29) << left
             << (to_string(static_cast<int>(data.temperatur + 0.5)) + "¬∞C") << "‚ïë" << endl;
        cout << "‚ïë  üíß  Luftfuktighet:  " << setw(29) << left
             << (to_string(static_cast<int>(data.luftfuktighet)) + "%") << "‚ïë" << endl;
        cout << "‚ïë  üí®  Vindhastighet:  " << setw(29) << left
             << (to_string(static_cast<int>(data.vindhastighet * 10) / 10.0) + " m/s") << "‚ïë" << endl;
        cout << "‚ïë  üìä  Lufttryck:      " << setw(29) << left
             << (to_string(static_cast<int>(data.lufttryck)) + " hPa") << "‚ïë" << endl;
        cout << "‚ïë  ‚òÅÔ∏è  Beskrivning:    " << setw(29) << left << data.beskrivning << "‚ïë" << endl;
        cout << "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" << endl;
        cout << "\n";
    }

    // Visa prognos i terminalen
    void visaPrognos(const VaderPrognos& prognos) {
        cout << "\n";
        cout << "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" << endl;
        cout << "‚ïë                 V√ÑDERPROGNOS                          ‚ïë" << endl;
        cout << "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" << endl;

        for (int i = 0; i < prognos.antal_dagar && i < 5; i++) {
            const VaderData& dag = prognos.dagar[i];
            cout << "‚ïë Dag " << (i + 1) << ": "
                 << setw(4) << right << static_cast<int>(dag.temperatur + 0.5) << "¬∞C - "
                 << setw(34) << left << dag.beskrivning << "‚ïë" << endl;
        }

        cout << "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" << endl;
        cout << "\n";
    }
};

// Huvudprogram
int main(int argc, char* argv[]) {
    try {
        // L√§s kommandoradsargument
        string server_adress = (argc > 1) ? argv[1] : "127.0.0.1";
        int server_port = (argc > 2) ? atoi(argv[2]) : 8080;

        cout << "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" << endl;
        cout << "‚ïë          V√ÑDERSYSTEM - C++-KLIENT                     ‚ïë" << endl;
        cout << "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n" << endl;

        // Skapa klientobjekt
        VaderKlient klient(server_adress, server_port);

        // Interaktiv loop
        while (true) {
            cout << "\n V√§lj alternativ:" << endl;
            cout << "  1. H√§mta aktuellt v√§der" << endl;
            cout << "  2. H√§mta v√§derprognos" << endl;
            cout << "  3. Avsluta" << endl;
            cout << "Val: ";

            int val;
            cin >> val;
            cin.ignore();  // Rensa newline

            if (val == 3) {
                break;
            }

            if (val != 1 && val != 2) {
                cout << "Ogiltigt val, f√∂rs√∂k igen" << endl;
                continue;
            }

            // L√§s in stad och landskod
            string stad, landskod;
            cout << "Ange stad: ";
            getline(cin, stad);

            cout << "Ange landskod (ex: SE, US, GB): ";
            getline(cin, landskod);

            // Anslut till server
            if (!klient.anslutt()) {
                cerr << "Kunde inte ansluta till server" << endl;
                continue;
            }

            // Utf√∂r operation
            if (val == 1) {
                klient.hamtaAktuellVader(stad, landskod);
            } else {
                klient.hamtaPrognos(stad, landskod);
            }

            // Koppla fr√•n
            klient.kopplaFran();
        }

        cout << "\nHejd√•!" << endl;

    } catch (const exception& e) {
        cerr << "UNDANTAG: " << e.what() << endl;
        return 1;
    }

    return 0;
}
