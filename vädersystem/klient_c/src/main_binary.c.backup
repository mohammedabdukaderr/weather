#include "vaderprotokoll.h"
#include "natverks_abstraktion.h"
#include <stdio.h>
#include <string.h>
#include <stdlib.h>

#define SERVER_ADRESS "127.0.0.1"  // Localhost som standard
#define SERVER_PORT 8080

// Visa vÃ¤derdata i terminalen
void visa_vader_data(const VaderData* data) {
    printf("\n");
    printf("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n");
    printf("â•‘             AKTUELLT VÃ„DER - %s\n", data->stad);
    printf("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n");
    printf("â•‘  ğŸŒ¡ï¸  Temperatur:    %.1fÂ°C\n", data->temperatur);
    printf("â•‘  ğŸ’§  Luftfuktighet:  %.0f%%\n", data->luftfuktighet);
    printf("â•‘  ğŸ’¨  Vindhastighet:  %.1f m/s\n", data->vindhastighet);
    printf("â•‘  ğŸ“Š  Lufttryck:      %.0f hPa\n", data->lufttryck);
    printf("â•‘  â˜ï¸  Beskrivning:    %s\n", data->beskrivning);
    printf("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    printf("\n");
}

// Visa prognos i terminalen
void visa_prognos(const VaderPrognos* prognos) {
    printf("\n");
    printf("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n");
    printf("â•‘             VÃ„DERPROGNOS\n");
    printf("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n");

    for (int i = 0; i < prognos->antal_dagar && i < 5; i++) {
        const VaderData* dag = &prognos->dagar[i];
        printf("â•‘ Dag %d: %.1fÂ°C - %s\n",
               i + 1, dag->temperatur, dag->beskrivning);
    }

    printf("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    printf("\n");
}

// Anslut till server
socket_t anslut_till_server(const char* server_adress, int port) {
    socket_t sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock == OGILTIG_SOCKET) {
        fprintf(stderr, "FEL: Kunde inte skapa socket\n");
        return OGILTIG_SOCKET;
    }

    struct sockaddr_in server_addr;
    memset(&server_addr, 0, sizeof(server_addr));
    server_addr.sin_family = AF_INET;
    server_addr.sin_port = htons((uint16_t)port);

#ifdef _WIN32
    server_addr.sin_addr.s_addr = inet_addr(server_adress);
#else
    inet_pton(AF_INET, server_adress, &server_addr.sin_addr);
#endif

    printf("Ansluter till server %s:%d...\n", server_adress, port);

    if (connect(sock, (struct sockaddr*)&server_addr, sizeof(server_addr)) < 0) {
        fprintf(stderr, "FEL: Kunde inte ansluta till server\n");
        fprintf(stderr, "Kontrollera att servern kÃ¶rs pÃ¥ %s:%d\n", server_adress, port);
        stang_socket(sock);
        return OGILTIG_SOCKET;
    }

    printf("Ansluten till server!\n");
    return sock;
}

// BegÃ¤r aktuellt vÃ¤der frÃ¥n server
bool begÃ¤r_aktuellt_vader(socket_t sock, const char* stad, const char* landskod) {
    // Skapa protokollhuvud
    ProtokollHuvud huvud;
    huvud.version = PROTOKOLL_VERSION;
    huvud.typ = MEDDELANDE_HAMTA_VADER;
    huvud.langd = hton16(sizeof(VaderForfragan));

    // Skapa vÃ¤derfÃ¶rfrÃ¥gan
    VaderForfragan forfragan;
    memset(&forfragan, 0, sizeof(forfragan));
    strncpy(forfragan.stad, stad, sizeof(forfragan.stad) - 1);
    strncpy(forfragan.landskod, landskod, sizeof(forfragan.landskod) - 1);

    // Skicka fÃ¶rfrÃ¥gan
    if (send(sock, (char*)&huvud, sizeof(huvud), 0) != sizeof(huvud)) {
        fprintf(stderr, "FEL: Kunde inte skicka protokollhuvud\n");
        return false;
    }

    if (send(sock, (char*)&forfragan, sizeof(forfragan), 0) != sizeof(forfragan)) {
        fprintf(stderr, "FEL: Kunde inte skicka vÃ¤derfÃ¶rfrÃ¥gan\n");
        return false;
    }

    // Ta emot svar
    ProtokollHuvud svar_huvud;
    if (recv(sock, (char*)&svar_huvud, sizeof(svar_huvud), 0) != sizeof(svar_huvud)) {
        fprintf(stderr, "FEL: Kunde inte ta emot svarshuvud\n");
        return false;
    }

    if (svar_huvud.typ == MEDDELANDE_FEL) {
        FelMeddelande fel;
        recv(sock, (char*)&fel, sizeof(fel), 0);
        fprintf(stderr, "FEL frÃ¥n server: %s (kod: %d)\n", fel.meddelande, fel.felkod);
        return false;
    }

    if (svar_huvud.typ != MEDDELANDE_VADER_SVAR) {
        fprintf(stderr, "FEL: OvÃ¤ntat svarstyp: %d\n", svar_huvud.typ);
        return false;
    }

    // Ta emot vÃ¤derdata
    VaderData vader_data;
    if (recv(sock, (char*)&vader_data, sizeof(vader_data), 0) != sizeof(vader_data)) {
        fprintf(stderr, "FEL: Kunde inte ta emot vÃ¤derdata\n");
        return false;
    }

    // Visa vÃ¤derdata
    visa_vader_data(&vader_data);
    return true;
}

// BegÃ¤r prognos frÃ¥n server
bool begÃ¤r_prognos(socket_t sock, const char* stad, const char* landskod) {
    // Skapa protokollhuvud
    ProtokollHuvud huvud;
    huvud.version = PROTOKOLL_VERSION;
    huvud.typ = MEDDELANDE_HAMTA_PROGNOS;
    huvud.langd = hton16(sizeof(VaderForfragan));

    // Skapa vÃ¤derfÃ¶rfrÃ¥gan
    VaderForfragan forfragan;
    memset(&forfragan, 0, sizeof(forfragan));
    strncpy(forfragan.stad, stad, sizeof(forfragan.stad) - 1);
    strncpy(forfragan.landskod, landskod, sizeof(forfragan.landskod) - 1);

    // Skicka fÃ¶rfrÃ¥gan
    send(sock, (char*)&huvud, sizeof(huvud), 0);
    send(sock, (char*)&forfragan, sizeof(forfragan), 0);

    // Ta emot svar
    ProtokollHuvud svar_huvud;
    recv(sock, (char*)&svar_huvud, sizeof(svar_huvud), 0);

    if (svar_huvud.typ == MEDDELANDE_FEL) {
        FelMeddelande fel;
        recv(sock, (char*)&fel, sizeof(fel), 0);
        fprintf(stderr, "FEL frÃ¥n server: %s\n", fel.meddelande);
        return false;
    }

    // Ta emot prognos
    VaderPrognos prognos;
    recv(sock, (char*)&prognos, sizeof(prognos), 0);

    // Visa prognos
    visa_prognos(&prognos);
    return true;
}

int main(int argc, char* argv[]) {
    // Initiera nÃ¤tverksbibliotek
    if (initiera_natverksbibliotek() != 0) {
        fprintf(stderr, "FEL: Kunde inte initialisera nÃ¤tverksbibliotek\n");
        return 1;
    }

    printf("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n");
    printf("â•‘          VÃ„DERSYSTEM - C-KLIENT                       â•‘\n");
    printf("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n");

    // AnvÃ¤nd kommandoradsargument eller standardvÃ¤rden
    const char* server_adress = (argc > 1) ? argv[1] : SERVER_ADRESS;
    int server_port = (argc > 2) ? atoi(argv[2]) : SERVER_PORT;

    // Interaktiv loop
    while (1) {
        printf("\nVÃ¤lj alternativ:\n");
        printf("  1. HÃ¤mta aktuellt vÃ¤der\n");
        printf("  2. HÃ¤mta vÃ¤derprognos\n");
        printf("  3. Avsluta\n");
        printf("Val: ");

        int val;
        if (scanf("%d", &val) != 1) {
            fprintf(stderr, "Ogiltigt val\n");
            while (getchar() != '\n');  // Rensa input-buffer
            continue;
        }
        while (getchar() != '\n');  // Rensa newline

        if (val == 3) {
            break;
        }

        if (val != 1 && val != 2) {
            printf("Ogiltigt val, fÃ¶rsÃ¶k igen\n");
            continue;
        }

        // Be om stad och landskod
        char stad[64];
        char landskod[3];

        printf("Ange stad: ");
        if (fgets(stad, sizeof(stad), stdin) == NULL) continue;
        stad[strcspn(stad, "\n")] = '\0';  // Ta bort newline

        printf("Ange landskod (ex: SE, US, GB): ");
        if (fgets(landskod, sizeof(landskod), stdin) == NULL) continue;
        landskod[strcspn(landskod, "\n")] = '\0';

        // Anslut till server
        socket_t sock = anslut_till_server(server_adress, server_port);
        if (sock == OGILTIG_SOCKET) {
            continue;
        }

        // UtfÃ¶r vald operation
        if (val == 1) {
            begÃ¤r_aktuellt_vader(sock, stad, landskod);
        } else {
            begÃ¤r_prognos(sock, stad, landskod);
        }

        // StÃ¤ng anslutning
        stang_socket(sock);
    }

    printf("\nHejdÃ¥!\n");
    rensa_natverksbibliotek();
    return 0;
}
